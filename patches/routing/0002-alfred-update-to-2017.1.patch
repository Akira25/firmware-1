From af4e5f6d7111ce340bb2f4318af2b8ca2a3a07c9 Mon Sep 17 00:00:00 2001
From: Moritz Warning <moritzwarning@web.de>
Date: Wed, 7 Jun 2017 15:09:15 +0200
Subject: [PATCH 2/4] alfred: update to 2017.1

---
 alfred/Makefile            |  8 ++++----
 alfred/files/bat-hosts.lua | 29 +++++++++++++++++------------
 2 files changed, 21 insertions(+), 16 deletions(-)

diff --git a/alfred/Makefile b/alfred/Makefile
index 379c0fe..c8725b7 100644
--- a/alfred/Makefile
+++ b/alfred/Makefile
@@ -11,10 +11,10 @@ include $(TOPDIR)/rules.mk
 # The latest alfred git hash in PKG_REV can be obtained from https://git.open-mesh.org/alfred.git
 #
 PKG_NAME:=alfred
-PKG_VERSION:=2016.5
-PKG_RELEASE:=0
-PKG_MD5SUM:=e03d422ed3b5a162b90e8af13389523f
-PKG_HASH:=37b3babf7f37643cf296be11fb82d5730cf441a5a56f72fba96edae9f149c9d2
+PKG_VERSION:=2017.1
+PKG_RELEASE:=1
+PKG_MD5SUM:=74e457ee49a6525ccdb3fa3bef58f685
+PKG_HASH:=f8d3a8058d076f6b7686696f6117de1780a2905d827dfa7faa3c2c0b24c2dfb0
 
 PKG_SOURCE:=$(PKG_NAME)-$(PKG_VERSION).tar.gz
 PKG_SOURCE_URL:=https://downloads.open-mesh.org/batman/releases/batman-adv-$(PKG_VERSION)
diff --git a/alfred/files/bat-hosts.lua b/alfred/files/bat-hosts.lua
index 8648caf..f9fe586 100644
--- a/alfred/files/bat-hosts.lua
+++ b/alfred/files/bat-hosts.lua
@@ -87,19 +87,24 @@ end
 
 local function receive_bat_hosts()
 -- read raw chunks from alfred, convert them to a nested table and call write_bat_hosts
-  local fd = io.popen("alfred -r " .. type_id)
-    --[[ this command returns something like
-    { "54:e6:fc:b9:cb:37", "00:11:22:33:44:55 ham_wlan0\x0a00:22:33:22:33:22 ham_eth0\x0a" },
-    { "90:f6:52:bb:ec:57", "00:22:33:22:33:23 spam\x0a" },
-    ]]--
-
-  if fd then
-    local output = fd:read("*a")
-    if output then
-      assert(loadstring("rows = {" .. output .. "}"))()
-      write_bat_hosts(rows)
+-- "alfred -r" can fail in slave nodes (returns empty stdout), so:
+-- check output is not null before writing /tmp/bat-hosts, and retry 3 times before giving up.
+  for n = 1, 3 do
+    local fd = io.popen("alfred -r " .. type_id)
+      --[[ this command returns something like
+      { "54:e6:fc:b9:cb:37", "00:11:22:33:44:55 ham_wlan0\x0a00:22:33:22:33:22 ham_eth0\x0a" },
+      { "90:f6:52:bb:ec:57", "00:22:33:22:33:23 spam\x0a" },
+      ]]--
+
+    if fd then
+      local output = fd:read("*a")
+      fd:close()
+      if output and output ~= "" then
+        assert(loadstring("rows = {" .. output .. "}"))()
+        write_bat_hosts(rows)
+        break
+      end
     end
-    fd:close()
   end
 end
 
-- 
2.1.4

